{% extends "base.html" %}

{% block extra_css %}
    <link rel="stylesheet" href="/mail_ai/app/static/css/writer.css">
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>üìù <span data-i18n="writer_page_title">AI Mail Writer</span></h3>
        <span id="saveStatus" class="save-status"></span>
    </div>

    <form action="/ui/writer/send" method="POST" id="mailForm">
        
        <input type="hidden" id="draftId" name="draft_id" value="{{ draft._id if draft else '' }}">

        <div class="card writer-card shadow">
            <div class="card-body">
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">
                            <i class="fas fa-paper-plane text-primary"></i> <span data-i18n="writer_label_account">Sender Account</span>
                        </label>
                        <select class="form-select" name="sender_email" id="senderEmail" required onchange="manualSave()">
                            {% for acc in accounts %}
                            <option value="{{ acc.email }}" 
                                {% if draft and draft.user_email == acc.email %}selected{% endif %}>
                                {{ acc.email }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text text-muted" style="font-size: 0.7rem;">
                            * <span data-i18n="writer_helper_account">Mail will be sent from this account using its signature.</span>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label">
                            <i class="fas fa-user text-success"></i> <span data-i18n="writer_label_to">To (Recipient)</span>
                        </label>
                        <input type="email" name="to_email" id="toEmail" class="form-control" 
                               placeholder="example@company.com" data-i18n="placeholder_email"
                               value="{{ draft.to if draft else '' }}" required>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label" data-i18n="writer_label_subject">Subject</label>
                    <input type="text" name="subject" id="subject" class="form-control" 
                           placeholder="e.g.: Project Proposal" data-i18n="placeholder_subject"
                           value="{{ draft.subject if draft else '' }}" required>
                </div>

                <hr class="border-secondary my-4">

                <div class="mb-3">
                    <label class="form-label text-warning">
                        <i class="fas fa-magic"></i> <span data-i18n="writer_label_ai_prompt">AI Instructions (Prompt)</span>
                    </label>
                    <div class="input-group">
                        <textarea id="aiPrompt" class="form-control" rows="2" 
                                  placeholder="e.g.: Thank the client for accepting our offer..." data-i18n="writer_placeholder_prompt"></textarea>
                        <button type="button" id="btnGenerate" class="btn btn-primary">
                            ü™Ñ <span data-i18n="writer_btn_generate">Generate Draft</span>
                        </button>
                    </div>
                    <div class="form-text text-muted" style="font-size: 0.8rem;">
                        <i class="fas fa-info-circle"></i> <span data-i18n="writer_helper_mic">Tip: Use the mic to dictate instructions, then say "Create".</span>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label text-success" data-i18n="writer_label_body">Mail Content (Editable):</label>
                    <textarea name="body" id="mailBody" class="form-control" rows="10" 
                              placeholder="AI generated text will appear here..." data-i18n="writer_placeholder_body" required>{{ draft.body | safe if draft else '' }}</textarea>
                </div>

                <div class="d-flex gap-2 justify-content-end">
                    <button type="button" class="btn btn-outline-warning" onclick="manualSave(true)" id="btnSave">
                        <i class="fas fa-save"></i> <span data-i18n="btn_save_draft">Save as Draft</span>
                    </button>

                    <a href="/ui/drafts" class="btn btn-outline-secondary">
                        <span data-i18n="btn_cancel_back">Cancel / Back to List</span>
                    </a>
                    
                    <button type="button" class="btn btn-success px-4" id="btnPreSend">
                        <i class="fas fa-paper-plane"></i> <span data-i18n="btn_send_mail">Send Mail</span>
                    </button>
                </div>

            </div>
        </div>
    </form>
</div>

<div class="voice-btn-container">
    <button id="voiceBtn" title="Hold to Speak">
        <i class="fas fa-microphone"></i>
    </button>
</div>

<div class="modal fade" id="confirmSendModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title text-warning">
            <i class="fas fa-exclamation-triangle"></i> <span data-i18n="modal_confirm_title">Confirm Send</span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="lead" data-i18n="modal_confirm_text">Are you sure you want to send this email?</p>
        <div class="card bg-secondary bg-opacity-10 border-0">
            <div class="card-body py-2">
                <small class="text-muted d-block" data-i18n="writer_label_to">To:</small>
                <strong id="confirmTo" class="d-block mb-2 text-white">...</strong>
                <small class="text-muted d-block" data-i18n="writer_label_subject">Subject:</small>
                <strong id="confirmSubject" class="text-white">...</strong>
            </div>
        </div>
        <p class="text-muted small mt-3 mb-0 text-center">
            <i class="fas fa-microphone"></i> <span data-i18n="modal_voice_hint">You can say "Confirm" to send instantly.</span>
        </p>
      </div>
      <div class="modal-footer border-secondary justify-content-between">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" data-i18n="btn_cancel">Cancel</button>
        <button type="button" class="btn btn-success px-4" id="btnConfirmSend">
            <i class="fas fa-paper-plane"></i> <span data-i18n="btn_confirm_send">Yes, Send It!</span>
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
    <script src="/mail_ai/app/static/js/translations.js"></script>
    <script src="/mail_ai/app/static/js/language_engine.js"></script>
        <script src="/mail_ai/app/static/js/voice.js"></script>
    <script src="/mail_ai/app/static/js/writer.js"></script>
{% endblock %}