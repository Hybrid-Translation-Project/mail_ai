{% extends "base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/dashboard.css">
{% endblock %}

{% block content %}
<section class="page-header">
    <div>
        <h2 class="page-title">ğŸ“¥ <span data-i18n="dashboard_title">Gelen Kutusu (BirleÅŸik)</span></h2>
        <p class="page-subtitle" data-i18n="dashboard_desc">TÃ¼m hesaplarÄ±ndan toplanan ve AI tarafÄ±ndan iÅŸlenen mailler.
        </p>
    </div>
    <div class="refresh-chip">
        <span data-i18n="dashboard_auto_refresh">Otomatik yenileme:</span>
        <span id="countdown" class="refresh-chip-value">15</span> sn
    </div>
</section>

<div id="searchResultsContainer"></div>

<div id="default-view">
    {% set pending_tasks = tasks|selectattr("status", "equalto", "WAITING_APPROVAL")|list|length if tasks else 0 %}
    {% if pending_tasks > 0 %}
    <div class="dashboard-alert alert-pulse">
        <span>
            âš ï¸ <strong data-i18n="dashboard_alert_ai">AI Bildirimi:</strong>
            <span data-i18n="alert_pending_start">OnayÄ±nÄ± bekleyen</span>
            <strong>{{ pending_tasks }}</strong>
            <span data-i18n="alert_pending_end">yeni gÃ¶rev/teklif var!</span>
        </span>
        <a href="/ui/tasks" class="btn btn-sm btn-warning dashboard-alert-btn"
            data-i18n="dashboard_btn_review_tasks">Ä°ncele ve Karar Ver</a>
    </div>
    {% endif %}

    {% if mails %}
    <div class="table-responsive app-table-wrapper">
        <table class="table app-table align-middle mb-0">
            <thead>
                <tr>
                    <th scope="col" data-i18n="table_date">Tarih</th>
                    <th scope="col" data-i18n="table_from">Kimden</th>
                    <th scope="col" data-i18n="table_subject_account">Konu & Hedef Hesap</th>
                    <th scope="col" class="text-center" data-i18n="table_ai_status">AI Durumu</th>
                    <th scope="col" class="text-center" data-i18n="table_action">Ä°ÅŸlem</th>
                </tr>
            </thead>
            <tbody>
                {% for mail in mails %}
                <tr
                    class="mail-row{% if mail.status == 'REPLIED' %} mail-row--replied{% elif mail.is_read %} mail-row--read{% endif %}">
                    <td class="mail-date">{{ mail.created_at.strftime('%d.%m %H:%M') }}</td>
                    <td>
                        <a href="/ui/contact/{{ mail.from }}" class="mail-from-link">{{ mail.from }}</a>
                    </td>
                    <td>
                        <div class="mail-account">
                            <span class="mail-account-pill">
                                <i class="fas fa-inbox"></i> {{ mail.user_email }}
                            </span>
                        </div>
                        <a href="/ui/view/{{ mail._id }}" class="mail-subject-link" title="TÃ¼m yazÄ±ÅŸmayÄ± gÃ¶r">{{
                            mail.subject }}</a>

                        {# TAGLERÄ° GÃ–STER (%100 GÃœVENLÄ°) #}
                        {% if mail.tags %}
                        <div class="mail-tag-list">
                            {% for tag_slug in mail.tags %}
                            {% set tag_info = tags_map.get(tag_slug) %}
                            {% if tag_info %}
                            <span class="badge tag-badge" data-bg-color="{{ tag_info.color }}">
                                <span data-i18n="tag_name_{{ tag_slug }}">{{ tag_info.name }}</span>
                            </span>
                            {% endif %}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </td>

                    <td class="text-center">
                        {% if mail.status == "REPLIED" %}
                        <span class="badge status-badge status-badge-replied">CEVAPLANDI</span>
                        {% else %}
                        <span class="badge status-badge status-badge-draft" data-i18n="badge_draft_ready">TASLAK
                            HAZIR</span>
                        {% endif %}
                    </td>

                    <td class="text-center">
                        <div class="row-actions">
                            {% if mail.status == "REPLIED" %}
                            <a href="/ui/view/{{ mail._id }}" class="btn btn-secondary btn-sm">GÃ¶rÃ¼ntÃ¼le</a>
                            {% else %}
                            <a href="/ui/editor/{{ mail._id }}" class="btn btn-primary btn-sm"
                                data-i18n="btn_inspect">Ä°ncele</a>
                            {% endif %}

                            <form action="/ui/mail/delete/{{ mail._id }}" method="post" class="inline-form"
                                onsubmit="return confirm('Delete completely? / Bu maili kalÄ±cÄ± olarak silmek istediÄŸine emin misin?');">
                                <button type="submit" class="btn btn-danger btn-sm btn-icon"
                                    title="Tamamen Sil">ğŸ—‘ï¸</button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% else %}
    <div class="empty-state">
        <div class="empty-icon">ğŸ“­</div>
        <h3 class="empty-title" data-i18n="dashboard_empty_title">Bekleyen mail yok!</h3>
        <p class="empty-text" data-i18n="dashboard_empty_desc">TÃ¼m baÄŸlÄ± hesaplarÄ±n kontrol ediliyor...</p>
        <div class="empty-actions">
            <button onclick="window.location.reload()" class="btn btn-secondary btn-sm">
                ğŸ”„ <span data-i18n="dashboard_btn_check_now">Åimdi Kontrol Et</span>
            </button>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/translations.js?v=6"></script>
<script src="/static/js/language_engine.js?v=6"></script>
<script src="/static/js/dashboard.js"></script>
<script src="/static/js/search.js"></script>
{% endblock %}